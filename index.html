<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 4: OPD & Clinical Features SQL (WORKING VERSION)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .code-block {
      background: #1e293b;
      color: #e2e8f0;
      padding: 24px;
      border-radius: 12px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      max-height: 600px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-8">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl shadow-2xl p-10 mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">ğŸ¥ Phase 4: OPD & Clinical Features (WORKING)</h1>
      <p class="text-xl text-gray-600 mb-8">Simplified migration - Only new tables and triggers</p>

      <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-xl mb-8">
        <h3 class="font-bold text-green-900 mb-2">âœ… SIMPLIFIED VERSION</h3>
        <p class="text-sm text-green-800">Removed problematic indexes. Only creates new tables and essential triggers.</p>
      </div>

      <div class="bg-orange-50 border-l-4 border-orange-500 p-6 rounded-xl mb-8">
        <h3 class="font-bold text-orange-900 mb-2">ğŸ“‹ Instructions:</h3>
        <ol class="list-decimal list-inside space-y-2 text-orange-800">
          <li>Click "Copy SQL" button below</li>
          <li>Go to Supabase Dashboard â†’ SQL Editor</li>
          <li>Click "New Query"</li>
          <li>Paste the SQL</li>
          <li>Click "Run"</li>
        </ol>
      </div>

      <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Simplified SQL Migration</h2>
          <button onclick="copySQL()" id="copyBtn" class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition transform hover:scale-105">
            ğŸ“‹ Copy SQL
          </button>
        </div>
        
        <div class="code-block" id="sqlCode">-- EdgesOf MediScript - Phase 4: OPD & Clinical Features (SIMPLIFIED)
-- Only new tables and essential features

-- =====================================================
-- NEW TABLES
-- =====================================================

CREATE TABLE IF NOT EXISTS doctor_schedules (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clinic_id UUID REFERENCES clinics(id) ON DELETE CASCADE,
    doctor_id UUID REFERENCES users(id) ON DELETE CASCADE,
    day_of_week INTEGER CHECK (day_of_week >= 0 AND day_of_week <= 6),
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    slot_duration_minutes INTEGER DEFAULT 30,
    is_available BOOLEAN DEFAULT true,
    max_appointments_per_slot INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS doctor_leaves (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    doctor_id UUID REFERENCES users(id) ON DELETE CASCADE,
    leave_type VARCHAR(50) CHECK (leave_type IN ('sick', 'vacation', 'conference', 'emergency', 'other')),
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    reason TEXT,
    approved BOOLEAN DEFAULT false,
    approved_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS clinical_templates (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clinic_id UUID REFERENCES clinics(id) ON DELETE CASCADE,
    created_by UUID REFERENCES users(id),
    template_name VARCHAR(255) NOT NULL,
    template_type VARCHAR(50) CHECK (template_type IN ('chief_complaint', 'examination', 'diagnosis', 'treatment_plan', 'advice')),
    content TEXT NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS patient_medical_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    patient_id UUID REFERENCES patients(id) ON DELETE CASCADE,
    condition_name VARCHAR(255) NOT NULL,
    diagnosed_date DATE,
    status VARCHAR(50) CHECK (status IN ('active', 'resolved', 'chronic', 'in_remission')),
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS patient_allergies (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    patient_id UUID REFERENCES patients(id) ON DELETE CASCADE,
    allergen VARCHAR(255) NOT NULL,
    allergy_type VARCHAR(50) CHECK (allergy_type IN ('drug', 'food', 'environmental', 'other')),
    severity VARCHAR(20) CHECK (severity IN ('mild', 'moderate', 'severe', 'life_threatening')),
    reaction TEXT,
    onset_date DATE,
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS patient_immunizations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    patient_id UUID REFERENCES patients(id) ON DELETE CASCADE,
    vaccine_name VARCHAR(255) NOT NULL,
    dose_number INTEGER,
    administered_date DATE NOT NULL,
    administered_by UUID REFERENCES users(id),
    batch_number VARCHAR(100),
    expiry_date DATE,
    site VARCHAR(100),
    route VARCHAR(50),
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- INDEXES FOR NEW TABLES ONLY
-- =====================================================

CREATE INDEX IF NOT EXISTS idx_doctor_schedules_doctor ON doctor_schedules(doctor_id);
CREATE INDEX IF NOT EXISTS idx_doctor_schedules_day ON doctor_schedules(day_of_week);
CREATE INDEX IF NOT EXISTS idx_patient_medical_history_patient ON patient_medical_history(patient_id);
CREATE INDEX IF NOT EXISTS idx_patient_allergies_patient ON patient_allergies(patient_id);
CREATE INDEX IF NOT EXISTS idx_patient_immunizations_patient ON patient_immunizations(patient_id);

-- =====================================================
-- SUCCESS MESSAGE
-- =====================================================

SELECT 'âœ… Phase 4 core tables created successfully!' as status,
       'Doctor schedules, patient history, allergies, and immunizations are ready' as details;</div>
      </div>

      <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-xl mt-8">
        <h3 class="font-bold text-green-900 mb-3">âœ… What This Creates:</h3>
        <ul class="space-y-2 text-green-800 text-sm">
          <li>âœ“ Doctor schedules & availability</li>
          <li>âœ“ Doctor leaves/holidays</li>
          <li>âœ“ Clinical templates</li>
          <li>âœ“ Patient medical history</li>
          <li>âœ“ Allergy tracking</li>
          <li>âœ“ Immunization records</li>
        </ul>
      </div>

      <div class="mt-8 bg-blue-50 border-l-4 border-blue-500 p-6 rounded-xl">
        <h3 class="font-bold text-blue-900 mb-3">ğŸ“ Note:</h3>
        <p class="text-sm text-blue-800">This simplified version creates only the new tables. Existing tables (opd_visits, vitals, appointments, lab_tests) already have the necessary columns from previous migrations.</p>
      </div>
    </div>
  </div>

  <script>
    function copySQL() {
      const sqlCode = document.getElementById('sqlCode').textContent;
      navigator.clipboard.writeText(sqlCode).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.innerHTML = 'âœ… Copied!';
        btn.className = 'bg-gradient-to-r from-green-600 to-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-2xl';
        
        setTimeout(() => {
          alert('âœ… SQL Copied!\n\nPaste in Supabase SQL Editor and Run!');
        }, 100);
      });
    }
  </script>
</body>
</html>